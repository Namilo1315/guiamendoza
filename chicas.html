<!-- HTML -->
<div id="featuredContainer" class="d-flex overflow-hidden position-relative"></div>

<!-- Modal Destacado -->
<div class="modal fade" id="modalDestacado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDestacadoTitulo"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalDestacadoImg" src="" class="img-fluid mb-3" alt="">
        <p id="modalDestacadoDescripcion"></p>
        <p id="modalDestacadoDireccion"></p>
        <a id="modalDestacadoWhatsapp" href="#" target="_blank" class="btn btn-success">
          <i class="bi bi-whatsapp me-1"></i> Contactar
        </a>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyC6xVk-lhu3Tl0MysJHvmVA3wTZslLFeWY",
  authDomain: "gestion-postulantes.firebaseapp.com",
  projectId: "gestion-postulantes",
  storageBucket: "gestion-postulantes.firebasestorage.app",
  messagingSenderId: "316005992021",
  appId: "1:316005992021:web:ba86c12b2ab189ac09b6dc"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Contenedores y UI
const comerciosContainer = document.getElementById("comerciosContainer");
const formRegistro = document.getElementById("formRegistro");
const searchInput = document.getElementById("searchInput");
const filterBtns = document.querySelectorAll(".filter-btn");
const featuredContainer = document.getElementById("featuredContainer");

// ======== AVATAR ========
function avatarIniciales(nombre="C"){ 
  return `<div class="avatar flex-shrink-0">${nombre.trim().split(/\s+/).slice(0,2).map(w=>w[0]?.toUpperCase()||"").join("") || "C"}</div>`; 
}

// ======== SCROLL SUAVE ========
const todosComerciosTitle = document.querySelector('#comercios1');
filterBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    todosComerciosTitle.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
});

// ======== CARD COMERCIO ========
function comercioCard({id, nombre,direccion,whatsapp,rubro}){
  const iniciales = (nombre||"")
    .trim()
    .split(" ")
    .map(p => p[0]?.toUpperCase())
    .slice(0,2)
    .join("");

  return `<div class="col-comercio" id="comercio-${id}">
    <div class="card card-hover h-100 p-3 position-relative">
      <button class="btn-close position-absolute top-0 end-0 m-2" 
              style="width:0px; height:1px;" 
              onclick="eliminarComercio('${id}')"></button>
      <div class="d-flex align-items-center gap-3">
        <div style="
          width:45px; height:45px; border-radius:50%;
          background-color:#0d6efd; color:#fff; font-weight:bold;
          display:flex; align-items:center; justify-content:center;
          border:2px solid #e0e0e0; box-shadow:0 2px 6px rgba(0,0,0,0.1);
        ">${iniciales}</div>
        <div class="flex-grow-1">
          <h6 class="mb-0 fw-bold text-primary">${nombre}</h6>
          <small class="text-muted">${rubro||"Sin rubro"}</small>
        </div>
      </div>
      <div class="mt-2 small d-flex align-items-start">
        <i class="bi bi-geo-alt-fill text-danger me-2"></i>${direccion||"—"}
      </div>
      <div class="mt-3">
        <a class="btn btn-outline-success w-100 rounded-pill fw-bold" target="_blank" href="https://wa.me/54${(whatsapp||"").replace(/\D/g,"")}">
          <i class="bi bi-whatsapp me-1"></i> WhatsApp
        </a>
      </div>
    </div>
  </div>`;
}

// ======== DESTACADOS ========
const FEATURED = [
  { nombre: "Panadería Aroma", descripcion: "Panes y facturas frescas", img: "https://images.unsplash.com/photo-1532012197267-da84d127e765?w=400&h=400&fit=crop", rubro: "Panadería", whatsapp: "2611122334", direccion: "Calle Falsa 123, Maipú" },
  { nombre: "Café y Té Boutique", descripcion: "Bebidas calientes y pastelería", img: "https://images.unsplash.com/photo-1495474472287-4d71bcdd2085?w=400&h=400&fit=crop", rubro: "Café", whatsapp: "2613344556", direccion: "Boulevard Central 78, Maipú" },
  { nombre: "Ferretería La Tuerca", descripcion: "Todo para tu hogar", img: "https://images.unsplash.com/photo-1505691938895-1758d7feb511?w=400&h=400&fit=crop", rubro: "Ferretería", whatsapp: "2612233445", direccion: "Avenida Principal 456, Maipú" }
];

// Generar card con modal
function destacadoCard({nombre, descripcion, img, whatsapp, direccion}){
  return `<div class="carrusel1-card">
    <div class="card card-hover h-100" onclick="abrirModalDestacado('${nombre}','${descripcion}','${img}','${direccion}','${whatsapp}')">
      <img src="${img}" class="card-img-top" alt="${nombre}">
      <div class="card-body d-flex flex-column">
        <h6 class="fw-bold text-primary">${nombre}</h6>
        <p class="text-muted small">${descripcion||""}</p>
        <div class="mt-auto small d-flex align-items-start mb-2"><i class="bi bi-geo-alt-fill text-danger me-2"></i>${direccion||"—"}</div>
        <a href="https://wa.me/54${(whatsapp||"").replace(/\D/g,"")}" target="_blank" class="btn btn-success w-100 rounded-pill"><i class="bi bi-whatsapp me-1"></i> Contactar</a>
      </div>
    </div>
  </div>`;
}

// Abrir modal destacado
window.abrirModalDestacado = function(nombre, descripcion, img, direccion, whatsapp){
  document.getElementById("modalDestacadoTitulo").innerText = nombre;
  document.getElementById("modalDestacadoDescripcion").innerText = descripcion;
  document.getElementById("modalDestacadoImg").src = img;
  document.getElementById("modalDestacadoImg").alt = nombre;
  document.getElementById("modalDestacadoDireccion").innerText = direccion;
  document.getElementById("modalDestacadoWhatsapp").href = `https://wa.me/54${whatsapp.replace(/\D/g,"")}`;
  new bootstrap.Modal(document.getElementById("modalDestacado")).show();
}

// Render destacados
featuredContainer.innerHTML = FEATURED.map(destacadoCard).join("");

// Carrusel
let index = 0;
function moveCarousel(step){
  const total = FEATURED.length;
  index = (index + step + total) % total;
  featuredContainer.style.transform = `translateX(-${index*20}%)`;
}
document.querySelector(".carrusel1-btn.prev")?.addEventListener("click", ()=> moveCarousel(-1));
document.querySelector(".carrusel1-btn.next")?.addEventListener("click", ()=> moveCarousel(1));
setInterval(()=> moveCarousel(1), 4000);

// ======== OBSERVER ANIMACIONES ========
const observer = new IntersectionObserver(entries=>{
  entries.forEach(e=>{ if(e.isIntersecting) e.target.classList.add("visible"); });
},{threshold:.2});
document.querySelectorAll("[data-animate]").forEach(el=>observer.observe(el));

// ======== BÚSQUEDA Y FILTRO ========
let todosComercios = [];
function aplicarRender(){
  const term = (searchInput.value||"").toLowerCase().trim();
  const rubroActivo = document.querySelector(".filter-btn.active")?.dataset?.rubro || "todos";

  const filtrados = todosComercios.filter(c=>{
    const coincideTexto = [c.nombre, c.direccion, c.rubro].filter(Boolean)
      .some(v=>String(v).toLowerCase().includes(term));
    const coincideRubro = rubroActivo==="todos" ? true : (c.rubro===rubroActivo);
    return coincideTexto && coincideRubro;
  });

  comerciosContainer.innerHTML = filtrados.map(comercioCard).join("") || `
    <div class="col-12">
      <div class="alert alert-light border text-center">No hay comercios para mostrar con esos filtros.</div>
    </div>`;
}

// Filtro
filterBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    filterBtns.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    aplicarRender();
  });
});

// Búsqueda
searchInput.addEventListener("input", ()=> aplicarRender());

// ======== FORMULARIO REGISTRO ========
function mostrarToast(mensaje, tipo="success", duracion=3000){
  const container = document.getElementById("toastContainer");
  const toastEl = document.createElement("div");
  toastEl.className = `toast align-items-center text-bg-${tipo} border-0`;
  toastEl.setAttribute("role", "alert");
  toastEl.setAttribute("aria-live", "assertive");
  toastEl.setAttribute("aria-atomic", "true");

  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${mensaje}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
    </div>
  `;

  container.appendChild(toastEl);
  const toast = new bootstrap.Toast(toastEl, { delay: duracion });
  toast.show();
  toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

formRegistro.addEventListener('submit', async (event) => {
  event.preventDefault();
  if (!formRegistro.checkValidity()) {
    formRegistro.classList.add('was-validated');
    return;
  }

  const nombre = document.getElementById("regNombre").value.trim();
  const direccion = document.getElementById("regDireccion").value.trim();
  const rubro = document.getElementById("regRubro").value;
  const whatsapp = document.getElementById("regWhatsapp").value.trim();

  try {
    await addDoc(collection(db,"comercios"), {
      nombre, direccion, rubro, whatsapp,
      createdAt: serverTimestamp()
    });
    formRegistro.reset();
    formRegistro.classList.remove('was-validated');
    bootstrap.Modal.getInstance(document.getElementById("modalRegistro")).hide();
    mostrarToast(`Comercio "${nombre}" registrado!!`, "success");
  } catch(e) {
    mostrarToast("Ocurrió un error al guardar. Intentá nuevamente.", "danger");
    console.error(e);
  }
});

// ======== SUSCRIPCIÓN TIEMPO REAL ========
function suscribirComercios(){
  const q = query(collection(db,"comercios"), orderBy("createdAt","desc"));
  onSnapshot(q, (snap)=>{
    todosComercios = snap.docs.map(d=>({id:d.id, ...d.data()}));
    aplicarRender();
  });
}

// ======== ELIMINAR COMERCIO ========
let comercioAEliminar = null;
window.eliminarComercio = function(id){
  comercioAEliminar = id;
  const modal = new bootstrap.Modal(document.getElementById('modalEliminar'));
  modal.show();
};

document.getElementById('btnConfirmEliminar').addEventListener('click', async ()=>{
  if(!comercioAEliminar) return;
  const clave = prompt("Ingrese la clave para eliminar este comercio:");
  if(clave !== "mono123"){ alert("Clave incorrecta."); return; }
  try{
    await deleteDoc(doc(db,"comercios",comercioAEliminar));
    const elem = document.getElementById(`comercio-${comercioAEliminar}`);
    if(elem) elem.remove();
    comercioAEliminar = null;
    bootstrap.Modal.getInstance(document.getElementById('modalEliminar')).hide();
  }catch(e){
    alert("Error al eliminar el comercio.");
    console.error(e);
  }
});

// ======== SEMILLA INICIAL ========
async function seedSiVacio(){
  const snap = await getDocs(collection(db,"comercios"));
  if(snap.empty){
    await addDoc(collection(db,"comercios"),{
      nombre:"Panadería La Espiga",
      direccion:"Av. San Martín 123",
      rubro:"Panadería",
      whatsapp:"2614567890",
      createdAt: serverTimestamp()
    });
    await addDoc(collection(db,"comercios"),{
      nombre:"Farmacia Central",
      direccion:"Belgrano 456",
      rubro:"Farmacia",
      whatsapp:"2611234567",
      createdAt: serverTimestamp()
    });
  }
}

// ======== INICIALIZAR ========
renderFeatured();
await seedSiVacio();
suscribirComercios();
</script>

